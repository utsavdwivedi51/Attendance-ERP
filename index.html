<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance ERP – Student & Teacher Portal</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#0b1220;          /* page background */
      --card:#121a2b;        /* panels */
      --muted:#8ea0bf;       /* secondary text */
      --text:#e9eefc;        /* primary text */
      --primary:#4f7cff;     /* brand */
      --primary-600:#3a64e6;
      --accent:#22c55e;      /* success */
      --danger:#ef4444;      /* danger */
      --warning:#f59e0b;     /* warning */
      --ring: rgba(79, 124, 255, .4);
    }
    *{ box-sizing: border-box }
    html, body{ height:100% }
    body{
      margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 80% -10%, #1a2450 0%, rgba(26,36,80,0) 60%) , var(--bg);
      color: var(--text); line-height:1.55;
    }
    a{ color: var(--primary); text-decoration: none }
    .container{ max-width:1100px; margin:0 auto; padding:24px }
    .center{ display:flex; align-items:center; justify-content:center }

    /* Cards */
    .card{ background: var(--card); border:1px solid rgba(255,255,255,.06); border-radius:18px; box-shadow: 0 10px 30px rgba(0,0,0,.25); }
    .card.pad{ padding:24px }

    /* Header */
    header{ position:sticky; top:0; z-index:10; backdrop-filter: blur(10px); background: linear-gradient(180deg, rgba(11,18,32,.85), rgba(11,18,32,.35)); border-bottom:1px solid rgba(255,255,255,.06) }
    header .row{ display:flex; gap:16px; align-items:center; justify-content:space-between; padding:14px 0 }
    .logo{ display:flex; align-items:center; gap:10px; font-weight:800; letter-spacing:.3px }
    .logo .mark{ width:34px; height:34px; border-radius:9px; background: linear-gradient(135deg, var(--primary), #7aa1ff); display:grid; place-items:center; color:white; font-weight:900 }

    .btn{ -webkit-tap-highlight-color: transparent; appearance:none; border:1px solid rgba(255,255,255,.08); padding:10px 14px; border-radius:12px; color:var(--text); background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.01)); cursor:pointer; font-weight:600 }
    .btn:hover{ border-color: rgba(255,255,255,.16) }
    .btn.primary{ background: linear-gradient(180deg, var(--primary), var(--primary-600)); border-color: transparent; box-shadow: 0 10px 18px rgba(79,124,255,.3) }
    .btn.ghost{ background:transparent }
    .btn.danger{ background: linear-gradient(180deg, var(--danger), #b91c1c); border-color: transparent }
    .btn.success{ background: linear-gradient(180deg, var(--accent), #16a34a); border-color: transparent }
    .btn.small{ padding:8px 10px; font-size:.9rem; border-radius:10px }

    /* Forms */
    .grid{ display:grid; gap:16px }
    .grid.cols-2{ grid-template-columns: repeat(2, minmax(0,1fr)) }
    .grid.cols-3{ grid-template-columns: repeat(3, minmax(0,1fr)) }

    .field{ display:grid; gap:8px }
    .field label{ color: var(--muted); font-size:.9rem }
    .input, select, textarea{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.09); background: rgba(255,255,255,.02); color: var(--text) }
    .input:focus, select:focus, textarea:focus{ outline:none; border-color: var(--primary); box-shadow: 0 0 0 4px var(--ring) }
    .row{ display:flex; gap:12px; align-items:center }
    .right{ margin-left:auto }

    /* Tabs / sections */
    .tabs{ display:flex; gap:8px; margin-bottom:10px; flex-wrap:wrap }
    .tab{ padding:10px 12px; border-radius:11px; border:1px solid rgba(255,255,255,.08); color:var(--muted); cursor:pointer; user-select:none }
    .tab.active{ color:var(--text); background: rgba(255,255,255,.06) }

    .hide{ display:none !important }

    /* Tables */
    table{ width:100%; border-collapse: collapse; border-spacing:0; overflow:hidden; border-radius:14px; font-size:.95rem }
    th, td{ padding:12px 12px; text-align:left; border-bottom:1px solid rgba(255,255,255,.06) }
    thead th{ position:sticky; top:0; background: rgba(255,255,255,.06); z-index:1 }
    tbody tr:hover td{ background: rgba(255,255,255,.03) }
    .chip{ display:inline-flex; align-items:center; gap:6px; padding:6px 10px; border-radius:999px; font-weight:600; font-size:.85rem }
    .chip.ok{ background: rgba(34,197,94,.15); color:#22c55e; border:1px solid rgba(34,197,94,.25) }
    .chip.bad{ background: rgba(239,68,68,.15); color:#ef4444; border:1px solid rgba(239,68,68,.25) }
    .chip.warn{ background: rgba(245,158,11,.15); color:#f59e0b; border:1px solid rgba(245,158,11,.25) }

    /* Auth page */
    .auth-wrap{ min-height:calc(100vh - 70px); display:grid; place-items:center; padding:24px }
    .auth{ width:min(980px, 100%); display:grid; grid-template-columns: 1.2fr 1fr; gap:18px }
    .auth .illustration{ background: radial-gradient(700px 400px at 0% -10%, rgba(79,124,255,.25), transparent), linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02)); border-radius:18px; padding:26px }
    .auth h1{ margin:0 0 10px 0; font-size:2rem }
    .auth p{ margin:0; color: var(--muted) }

    /* Dashboard layout */
    .dash{ display:grid; grid-template-columns: 250px 1fr; gap:18px; min-height: calc(100vh - 110px) }
    .side{ position:sticky; top:86px; height: fit-content; }
    .nav{ display:grid; gap:8px }
    .nav .item{ display:flex; gap:10px; padding:10px 12px; border-radius:12px; cursor:pointer; color: var(--muted); border:1px solid transparent }
    .nav .item.active, .nav .item:hover{ color: var(--text); background: rgba(255,255,255,.06); border-color: rgba(255,255,255,.08) }

    .section{ display:grid; gap:16px }
    .stats{ display:grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap:12px }
    .stat{ padding:16px; border-radius:14px; background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.06) }
    .stat .big{ font-size:1.6rem; font-weight:800 }

    .pill{ font-size:.8rem; color:var(--muted); border:1px dashed rgba(255,255,255,.15); padding:6px 10px; border-radius:999px }

    /* Responsive */
    @media (max-width:1000px){
      .auth{ grid-template-columns: 1fr }
      .dash{ grid-template-columns: 1fr }
      .side{ position:relative; top:0 }
      .stats{ grid-template-columns: repeat(2, minmax(0,1fr)) }
      header .row{ flex-wrap:wrap }
    }
  </style>
</head>
<body>
  <header>
    <div class="container row">
      <div class="logo">
        <div class="mark">UGI</div>
        <div>UGIverse <span class="pill">Attendance ERP</span></div>
      </div>
      <div class="row">
        <button class="btn ghost" id="navHomeBtn">Home</button>
        <button class="btn ghost hide" id="navLogoutBtn">Logout</button>
      </div>
    </div>
  </header>

  <!-- AUTH -->
  <main class="auth-wrap" id="authPage">
    <div class="auth">
      <div class="illustration card">
        <h1>Student & Teacher Portal</h1>
        <p>Developed by <strong>UGIverse</strong></p> <p> Your whole college universe in one website </p>
        <div style="height:16px"></div>
        <div class="grid cols-2">
          <div class="stat">
            <div class="big" id="statStudents">0</div>
            <div class="muted">Students</div>
          </div>
          <div class="stat">
            <div class="big" id="statClasses">0</div>
            <div class="muted">Classes</div>
          </div>
          <div class="stat">
            <div class="big" id="statToday">0%</div>
            <div class="muted">Today Present</div>
          </div>
          <div class="stat">
            <div class="big" id="statRecords">0</div>
            <div class="muted">Attendance Records</div>
          </div>
        </div>
      </div>

      <div class="card pad">
        <h2 style="margin:0 0 8px 0">Login</h2>
        <div class="grid">
          <div class="field">
            <label>Login as</label>
            <div class="row">
              <label class="row"><input type="radio" name="role" value="teacher" checked> &nbsp;Teacher</label>
              <label class="row"><input type="radio" name="role" value="student"> &nbsp;Student</label>
            </div>
          </div>
          <div class="field">
            <label>Email / ID</label>
            <input class="input" id="loginId" placeholder="Enter email or ID" />
          </div>
          <div class="field">
            <label>Password</label>
            <div class="row" style="width:100%">
              <input class="input" id="loginPass" type="password" placeholder="Enter your password" style="flex:1" />
              <button class="btn small" id="togglePass" type="button">Show</button>
            </div>
            <small style="color:var(--muted)"> <code></code>  <code></code></small>
          </div>
          <div class="row">
            <button class="btn primary" id="loginBtn">Sign in</button>
            <div class="right" id="loginMsg" style="color:var(--warning)"></div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- DASHBOARD -->
  <section class="container dash hide" id="dash">
    <aside class="side card pad">
      <div class="row" style="justify-content:space-between">
        <div id="userName" style="font-weight:800">User</div>
        <div class="pill" id="userRole">teacher</div>
      </div>
      <div class="nav" id="nav">
        <div class="item active" data-target="teacherHome" id="navTeacherHome">Overview</div>
        <div class="item" data-target="manageStudents" id="navManageStudents">Students</div>
        <div class="item" data-target="takeAttendance" id="navTakeAttendance">Take Attendance</div>
        <div class="item" data-target="reports" id="navReports">Reports</div>

        <div class="item hide" data-target="studentHome" id="navStudentHome">My Attendance</div>
      </div>
      <div class="row" style="margin-top:10px">
        <button class="btn small right" id="logoutBtn">Logout</button>
      </div>
    </aside>

    <main class="section">
      <!-- TEACHER OVERVIEW -->
      <div id="teacherHome" class="card pad">
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <h2 style="margin:0">Overview</h2>
            <p style="margin:6px 0 0 0; color:var(--muted)">Quick stats for today: <span id="todayDate"></span></p>
          </div>
          <div class="row">
            <button class="btn" id="seedBtn">Reset Demo Data</button>
            <button class="btn primary" id="quickTakeBtn">Quick Take</button>
          </div>
        </div>
        <div class="stats" style="margin-top:14px">
          <div class="stat">
            <div class="big" id="tStatStudents">0</div>
            <div>Students</div>
          </div>
          <div class="stat">
            <div class="big" id="tStatClasses">0</div>
            <div>Classes</div>
          </div>
          <div class="stat">
            <div class="big" id="tStatPresent">0%</div>
            <div>Present Today</div>
          </div>
          <div class="stat">
            <div class="big" id="tStatRecords">0</div>
            <div>Total Records</div>
          </div>
        </div>
      </div>

      <!-- MANAGE STUDENTS -->
      <div id="manageStudents" class="card pad hide">
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <h2 style="margin:0">Students</h2>
            <p style="margin:6px 0 0 0; color:var(--muted)">Add, edit or remove students. Students can log in with their ID and password.</p>
          </div>
          <div class="row">
            <input class="input" id="studentSearch" placeholder="Search by name, roll or class" />
            <button class="btn" id="exportStudentsBtn">Export CSV</button>
          </div>
        </div>

        <div class="grid cols-3" style="margin-top:12px">
          <div class="field">
            <label>Full Name</label>
            <input class="input" id="sName" placeholder="Enter Student Name" />
          </div>
          <div class="field">
            <label>Roll No.</label>
            <input class="input" id="sRoll" placeholder="Enter Roll No" />
          </div>
          <div class="field">
            <label>Class</label>
            <input class="input" id="sClass" placeholder="Enter Class" />
          </div>
          <div class="field">
            <label>Email (optional)</label>
            <input class="input" id="sEmail" placeholder="Enter email" />
          </div>
          <div class="field">
            <label>Password</label>
            <input class="input" id="sPass" placeholder="Set a password" />
          </div>
          <div class="field">
            <label>&nbsp;</label>
            <button class="btn success" id="addStudentBtn">Add Student</button>
          </div>
        </div>

        <div class="card" style="padding:0; margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Roll</th>
                <th>Class</th>
                <th>Email</th>
                <th>ID</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody id="studentsTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- TAKE ATTENDANCE -->
      <div id="takeAttendance" class="card pad hide">
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <h2 style="margin:0">Take Attendance</h2>
            <p style="margin:6px 0 0 0; color:var(--muted)">Select the date and mark students as Present/Absent.</p>
          </div>
          <div class="row">
            <input class="input" id="attDate" type="date" />
            <button class="btn" id="markAllPresentBtn">Mark All Present</button>
            <button class="btn" id="clearMarksBtn">Clear</button>
            <button class="btn primary" id="saveAttendanceBtn">Save</button>
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <select id="classFilter" class="input" style="max-width:220px">
            <option value="">All Classes</option>
          </select>
          <input class="input" id="attSearch" placeholder="Filter by name / roll" />
        </div>

        <div class="card" style="padding:0; margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Name</th>
                <th>Roll</th>
                <th>Class</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="attTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- REPORTS -->
      <div id="reports" class="card pad hide">
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <h2 style="margin:0">Reports</h2>
            <p style="margin:6px 0 0 0; color:var(--muted)">Download attendance or view per-student summaries.</p>
          </div>
          <div class="row">
            <input type="month" class="input" id="repMonth">
            <button class="btn" id="exportAttendanceBtn">Export CSV</button>
          </div>
        </div>
        <div class="card" style="padding:0; margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Student</th>
                <th>Roll</th>
                <th>Class</th>
                <th>Present</th>
                <th>Absent</th>
                <th>Percentage</th>
              </tr>
            </thead>
            <tbody id="repTbody"></tbody>
          </table>
        </div>
      </div>

      <!-- STUDENT HOME -->
      <div id="studentHome" class="card pad hide">
        <div class="row" style="justify-content:space-between; align-items:flex-end">
          <div>
            <h2 style="margin:0">My Attendance</h2>
            <p style="margin:6px 0 0 0; color:var(--muted)">Welcome, <span id="stuWelcome"></span> — your attendance overview.</p>
          </div>
          <div class="row">
            <input type="month" id="stuMonth" class="input">
            <button class="btn" id="stuExportBtn">Export My CSV</button>
          </div>
        </div>

        <div class="stats" style="margin-top:14px">
          <div class="stat">
            <div class="big" id="stuPresent">0</div>
            <div>Present</div>
          </div>
          <div class="stat">
            <div class="big" id="stuAbsent">0</div>
            <div>Absent</div>
          </div>
          <div class="stat">
            <div class="big" id="stuPercent">0%</div>
            <div>Percentage</div>
          </div>
          <div class="stat">
            <div class="big" id="stuStreak">0</div>
            <div>Current Streak (days)</div>
          </div>
        </div>

        <div class="card" style="padding:0; margin-top:12px">
          <table>
            <thead>
              <tr>
                <th>Date</th>
                <th>Status</th>
              </tr>
            </thead>
            <tbody id="stuTbody"></tbody>
          </table>
        </div>
      </div>
    </main>
  </section>

  <script>
    /* =====================
       Utilities & Storage
       ===================== */
    const $ = (q, root=document) => root.querySelector(q);
    const $$ = (q, root=document) => Array.from(root.querySelectorAll(q));
    const todayISO = () => new Date().toISOString().slice(0,10);
    const monISO = () => new Date().toISOString().slice(0,7);

    const db = {
      get(key, fallback){
        try{ return JSON.parse(localStorage.getItem(key)) ?? fallback }catch{ return fallback }
      },
      set(key, val){ localStorage.setItem(key, JSON.stringify(val)) }
    }

    const store = {
      users: 'sl_users',
      students: 'sl_students',
      attendance: 'sl_attendance', // array of {date, studentId, status}
    }

    function uid(prefix='U'){
      return prefix + Math.random().toString(36).slice(2,8).toUpperCase();
    }

    function seeded(){ return db.get('sl_seeded', false) }
    function setSeeded(v){ db.set('sl_seeded', !!v) }

    function seedDemo(){
      // Teacher
      const users = [
        { id: 'T001', role:'teacher', email:'Jitendra Kumar', password:'teacher123', name:'Admin Teacher' }
      ];

      // Students
      const students = [
        { id:'97230265', name:'Om Malviya', roll:'2412105201203', class:'CS-6A', email:'mrmalviyaji@gmail.com', password:'om@123' },
        { id:'97230020', name:'Shristi Gupta', roll:'2412105201312', class:'CS-6A', email:'shristigupta@gmail.com', password:'shristi@123' },
        { id:'97230216', name:'Sakshi Dwivedi', roll:'2412105201262', class:'CS-6B', email:'sakshidwivedi@gmail.com', password:'sakshi@123' },
        { id:'97230402', name:'Akshay Singh', roll:'2412105201205', class:'CS-6B', email:'akshay12@gmail.com', password:'akshay@123' }
      ];

      // Attendance for last 10 days
      const attendance = [];
      const now = new Date();
      for(let d=0; d<10; d++){
        const date = new Date(now);
        date.setDate(now.getDate()-d);
        const iso = date.toISOString().slice(0,10);
        for(const s of students){
          // random-ish pattern
          const present = Math.random() > 0.15;
          attendance.push({date: iso, studentId: s.id, status: present ? 'P' : 'A'});
        }
      }

      db.set(store.users, users);
      db.set(store.students, students);
      db.set(store.attendance, attendance);
      setSeeded(true);
    }

    function ensureSeed(){ if(!seeded()){ seedDemo() } }

    /* =====================
       Auth
       ===================== */
    const auth = {
      current: null,
      login(idOrEmail, password, role){
        const users = db.get(store.users, []);
        const students = db.get(store.students, []);
        if(role === 'teacher'){
          const u = users.find(u=> (u.email?.toLowerCase()===idOrEmail.toLowerCase()) && u.password===password);
          if(u){ this.current = u; sessionStorage.setItem('sl_user', JSON.stringify(u)); return {ok:true, user:u} }
        }else{
          const s = students.find(s=> (s.id===idOrEmail || s.email?.toLowerCase()===idOrEmail.toLowerCase()) && s.password===password);
          if(s){ this.current = {...s, role:'student'}; sessionStorage.setItem('sl_user', JSON.stringify(this.current)); return {ok:true, user:this.current} }
        }
        return {ok:false, msg:'Invalid credentials'}
      },
      logout(){ this.current=null; sessionStorage.removeItem('sl_user') },
      load(){ try{ this.current = JSON.parse(sessionStorage.getItem('sl_user')); return this.current }catch{ return null } }
    }

    /* =====================
       DOM Handlers
       ===================== */
    const authPage = $('#authPage');
    const dash = $('#dash');
    const loginBtn = $('#loginBtn');
    const togglePass = $('#togglePass');
    const loginId = $('#loginId');
    const loginPass = $('#loginPass');
    const loginMsg = $('#loginMsg');
    const navLogoutBtn = $('#navLogoutBtn');
    const logoutBtn = $('#logoutBtn');

    const userName = $('#userName');
    const userRole = $('#userRole');
    const nav = $('#nav');

    const todayDate = $('#todayDate');

    // Sections
    const sections = ['teacherHome','manageStudents','takeAttendance','reports','studentHome'];

    function show(el){ el.classList.remove('hide') }
    function hide(el){ el.classList.add('hide') }
    function setActive(id){ sections.forEach(s=> hide($('#'+s))); show($('#'+id)); $$('.nav .item').forEach(i=> i.classList.toggle('active', i.dataset.target===id)); }

    // Stats on Auth page
    function refreshLandingStats(){
      const students = db.get(store.students, []);
      const att = db.get(store.attendance, []);
      const classes = [...new Set(students.map(s=>s.class))];
      const today = todayISO();
      const todays = att.filter(r=>r.date===today);
      const present = todays.filter(r=>r.status==='P').length;
      $('#statStudents').textContent = students.length;
      $('#statClasses').textContent = classes.length;
      $('#statRecords').textContent = att.length;
      $('#statToday').textContent = todays.length? Math.round(present/todays.length*100)+'%':'0%';
    }

    function refreshTeacherStats(){
      const students = db.get(store.students, []);
      const att = db.get(store.attendance, []);
      const classes = [...new Set(students.map(s=>s.class))];
      const today = todayISO();
      const todays = att.filter(r=>r.date===today);
      const present = todays.filter(r=>r.status==='P').length;
      $('#tStatStudents').textContent = students.length;
      $('#tStatClasses').textContent = classes.length;
      $('#tStatRecords').textContent = att.length;
      $('#tStatPresent').textContent = todays.length? Math.round(present/todays.length*100)+'%':'0%';
      todayDate.textContent = new Date().toLocaleDateString();
    }

    /* =====================
       Students CRUD
       ===================== */
    const sName = $('#sName');
    const sRoll = $('#sRoll');
    const sClass = $('#sClass');
    const sEmail = $('#sEmail');
    const sPass = $('#sPass');
    const addStudentBtn = $('#addStudentBtn');
    const studentsTbody = $('#studentsTbody');
    const studentSearch = $('#studentSearch');

    function listStudents(filter=''){
      const students = db.get(store.students, []);
      const q = filter.toLowerCase();
      const filtered = students.filter(s=> [s.name, s.roll, s.class].some(x=> String(x).toLowerCase().includes(q)));

      studentsTbody.innerHTML = '';
      filtered.forEach((s, i)=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${s.name}</td>
          <td>${s.roll}</td>
          <td>${s.class}</td>
          <td>${s.email??''}</td>
          <td><code>${s.id}</code></td>
          <td class="row">
            <button class="btn small" data-act="reset" data-id="${s.id}">Reset PW</button>
            <button class="btn small danger" data-act="del" data-id="${s.id}">Delete</button>
          </td>
        `;
        studentsTbody.appendChild(tr);
      })
    }

    function refreshClassFilter(){
      const students = db.get(store.students, []);
      const classes = [...new Set(students.map(s=>s.class))].sort();
      const sel = $('#classFilter');
      sel.innerHTML = '<option value="">All Classes</option>' + classes.map(c=>`<option value="${c}">${c}</option>`).join('');
    }

    addStudentBtn.addEventListener('click', ()=>{
      const name = sName.value.trim();
      const roll = sRoll.value.trim();
      const cls = sClass.value.trim();
      const email = sEmail.value.trim();
      const pass = sPass.value.trim() || Math.random().toString(36).slice(2,8);
      if(!name || !roll || !cls){ alert('Name, Roll and Class are required'); return }
      const students = db.get(store.students, []);
      const id = 'S' + roll.padStart(4,'0');
      if(students.some(x=>x.id===id)){ alert('A student with this roll already exists.'); return }
      students.push({ id, name, roll, class: cls, email, password: pass });
      db.set(store.students, students);
      sName.value = sRoll.value = sClass.value = sEmail.value = sPass.value = '';
      listStudents(studentSearch.value);
      refreshClassFilter();
      refreshTeacherStats();
    })

    studentsTbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const id = btn.dataset.id; const act = btn.dataset.act;
      const students = db.get(store.students, []);
      const idx = students.findIndex(s=>s.id===id);
      if(idx===-1) return;
      if(act==='del'){
        if(confirm('Delete this student?')){
          students.splice(idx,1); db.set(store.students, students);
          // also remove attendance
          const attendance = db.get(store.attendance, []);
          db.set(store.attendance, attendance.filter(r=>r.studentId!==id));
          listStudents(studentSearch.value); refreshClassFilter(); refreshTeacherStats();
        }
      }else if(act==='reset'){
        const npw = prompt('Enter new password for '+students[idx].name, 'pass123');
        if(npw){ students[idx].password=npw; db.set(store.students, students); alert('Password updated.') }
      }
    })

    studentSearch.addEventListener('input', e=> listStudents(e.target.value));

    // Export students CSV
    $('#exportStudentsBtn').addEventListener('click', ()=>{
      const students = db.get(store.students, []);
      const rows = [['ID','Name','Roll','Class','Email']].concat(students.map(s=>[s.id,s.name,s.roll,s.class,s.email||'']))
      downloadCSV(rows, 'students.csv');
    })

    /* =====================
       Take Attendance
       ===================== */
    const attTbody = $('#attTbody');
    const attDate = $('#attDate');
    const attSearch = $('#attSearch');
    const markAllPresentBtn = $('#markAllPresentBtn');
    const clearMarksBtn = $('#clearMarksBtn');

    function renderAttendanceTable(){
      const students = db.get(store.students, []);
      const q = attSearch.value.trim().toLowerCase();
      const cls = $('#classFilter').value;
      const date = attDate.value || todayISO();

      const att = db.get(store.attendance, []);
      const existing = new Map(att.filter(r=>r.date===date).map(r=> [r.studentId, r.status]));

      const view = students
        .filter(s=> (cls? s.class===cls : true))
        .filter(s=> [s.name, s.roll].some(x=> String(x).toLowerCase().includes(q)) )
        .sort((a,b)=> a.roll.localeCompare(b.roll));

      attTbody.innerHTML = '';
      view.forEach((s,i)=>{
        const tr = document.createElement('tr');
        const status = existing.get(s.id) || '';
        tr.innerHTML = `
          <td>${i+1}</td>
          <td>${s.name}</td>
          <td>${s.roll}</td>
          <td>${s.class}</td>
          <td>
            <div class="row">
              <button class="btn small ${status==='P'?'success':''}" data-sid="${s.id}" data-status="P">Present</button>
              <button class="btn small ${status==='A'?'danger':''}" data-sid="${s.id}" data-status="A">Absent</button>
              <span class="chip ${status==='P'?'ok':status==='A'?'bad':'warn'}">${status===''?'—':(status==='P'?'Present':'Absent')}</span>
            </div>
          </td>
        `;
        attTbody.appendChild(tr);
      })
    }

    attTbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const sid = btn.dataset.sid; const status = btn.dataset.status;
      const date = attDate.value || todayISO();
      let att = db.get(store.attendance, []);
      const idx = att.findIndex(r=> r.date===date && r.studentId===sid);
      if(idx>-1){ att[idx].status=status } else { att.push({date, studentId:sid, status}) }
      db.set(store.attendance, att);
      renderAttendanceTable(); refreshTeacherStats(); refreshLandingStats();
    })

    $('#classFilter').addEventListener('change', renderAttendanceTable);
    attSearch.addEventListener('input', renderAttendanceTable);
    attDate.addEventListener('change', renderAttendanceTable);

    $('#saveAttendanceBtn').addEventListener('click', ()=>{
      alert('Attendance saved for '+ (attDate.value || todayISO()));
    })
    markAllPresentBtn.addEventListener('click', ()=>{
      const date = attDate.value || todayISO();
      const students = db.get(store.students, []);
      let att = db.get(store.attendance, []);
      for(const s of students){
        const idx = att.findIndex(r=> r.date===date && r.studentId===s.id);
        if(idx>-1) att[idx].status='P'; else att.push({date, studentId:s.id, status:'P'});
      }
      db.set(store.attendance, att); renderAttendanceTable(); refreshTeacherStats();
    })
    clearMarksBtn.addEventListener('click', ()=>{
      const date = attDate.value || todayISO();
      let att = db.get(store.attendance, []);
      att = att.filter(r=> r.date !== date);
      db.set(store.attendance, att); renderAttendanceTable(); refreshTeacherStats();
    })

    // Export attendance CSV
    $('#exportAttendanceBtn').addEventListener('click', ()=>{
      const month = $('#repMonth').value || monISO();
      const rows = buildAttendanceCSV(month);
      downloadCSV(rows, `attendance_${month}.csv`);
    })

    // Reports table
    function renderReports(){
      const month = $('#repMonth').value || monISO();
      const students = db.get(store.students, []);
      const att = db.get(store.attendance, []);
      const inMonth = att.filter(r=> r.date.startsWith(month));
      const byStu = new Map();
      for(const r of inMonth){
        const o = byStu.get(r.studentId) || {P:0,A:0};
        o[r.status]++; byStu.set(r.studentId, o);
      }
      const tbody = $('#repTbody');
      tbody.innerHTML='';
      for(const s of students){
        const o = byStu.get(s.id) || {P:0,A:0};
        const total = o.P + o.A; const pct = total? Math.round(o.P/total*100) : 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${s.name}</td>
          <td>${s.roll}</td>
          <td>${s.class}</td>
          <td>${o.P}</td>
          <td>${o.A}</td>
          <td><span class="chip ${pct>=75?'ok':pct>=50?'warn':'bad'}">${pct}%</span></td>
        `;
        tbody.appendChild(tr);
      }
    }

    /* =====================
       Student View
       ===================== */
    function renderStudentHome(){
      const u = auth.current; if(!u) return;
      $('#stuWelcome').textContent = u.name;
      const month = $('#stuMonth').value || monISO();
      const att = db.get(store.attendance, []).filter(r=> r.studentId===u.id && r.date.startsWith(month));
      const tbody = $('#stuTbody'); tbody.innerHTML='';
      let P=0, A=0; let streak=0; let prevDate=null;
      // sort by date asc
      att.sort((a,b)=> a.date.localeCompare(b.date));
      for(const r of att){
        if(r.status==='P') P++; else A++;
        // streak calc (consecutive present)
        if(r.status==='P'){
          if(!prevDate) streak=1; else {
            const d1 = new Date(prevDate), d2 = new Date(r.date);
            const diff = (d2 - d1) / (1000*60*60*24);
            streak = (diff===1) ? streak+1 : 1;
          }
          prevDate = r.date;
        }
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.date}</td><td>${r.status==='P'?'<span class="chip ok">Present</span>':'<span class="chip bad">Absent</span>'}</td>`;
        tbody.appendChild(tr);
      }
      const total = P + A; const pct = total? Math.round(P/total*100) : 0;
      $('#stuPresent').textContent=P; $('#stuAbsent').textContent=A; $('#stuPercent').textContent=pct+'%'; $('#stuStreak').textContent=streak;
    }

    $('#stuMonth').addEventListener('change', renderStudentHome);
    $('#stuExportBtn').addEventListener('click', ()=>{
      const u = auth.current; if(!u) return;
      const month = $('#stuMonth').value || monISO();
      const rows = buildAttendanceCSV(month, u.id);
      downloadCSV(rows, `attendance_${u.id}_${month}.csv`);
    })

    /* =====================
       CSV helpers
       ===================== */
    function buildAttendanceCSV(month, onlyStudentId=null){
      const students = db.get(store.students, []);
      const mapStu = new Map(students.map(s=> [s.id, s]));
      const att = db.get(store.attendance, []).filter(r=> r.date.startsWith(month));
      const rows = [['Date','Student ID','Name','Roll','Class','Status']];
      for(const r of att){
        if(onlyStudentId && r.studentId!==onlyStudentId) continue;
        const s = mapStu.get(r.studentId); if(!s) continue;
        rows.push([r.date, s.id, s.name, s.roll, s.class, r.status==='P'?'Present':'Absent']);
      }
      return rows;
    }

    function downloadCSV(rows, filename){
      const csv = rows.map(r=> r.map(x=> '"'+String(x).replaceAll('"','""')+'"').join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; a.click(); URL.revokeObjectURL(url);
    }

    /* =====================
       Navigation & Auth flow
       ===================== */
    function enterDashboard(){
      hide(authPage); show(dash); show(navLogoutBtn);
      const u = auth.current; userName.textContent = u.name; userRole.textContent = u.role;
      if(u.role==='teacher'){
        $('#navTeacherHome').classList.remove('hide');
        $('#navManageStudents').classList.remove('hide');
        $('#navTakeAttendance').classList.remove('hide');
        $('#navReports').classList.remove('hide');
        $('#navStudentHome').classList.add('hide');
        setActive('teacherHome'); refreshTeacherStats(); listStudents(); refreshClassFilter();
        attDate.value = todayISO(); renderAttendanceTable();
        $('#repMonth').value = monISO(); renderReports();
      }else{
        $('#navTeacherHome').classList.add('hide');
        $('#navManageStudents').classList.add('hide');
        $('#navTakeAttendance').classList.add('hide');
        $('#navReports').classList.add('hide');
        $('#navStudentHome').classList.remove('hide');
        setActive('studentHome'); $('#stuMonth').value = monISO(); renderStudentHome();
      }
    }

    function leaveDashboard(){
      show(authPage); hide(dash); hide(navLogoutBtn); refreshLandingStats(); loginPass.value='';
    }

    loginBtn.addEventListener('click', ()=>{
      const role = document.querySelector('input[name="role"]:checked').value;
      const id = loginId.value.trim(); const pw = loginPass.value.trim();
      if(!id || !pw){ loginMsg.textContent = 'Please fill all fields.'; return }
      const res = auth.login(id, pw, role);
      if(res.ok){ loginMsg.textContent=''; enterDashboard() } else { loginMsg.textContent = 'Invalid '+role+' credentials.' }
    })

    togglePass.addEventListener('click', ()=>{
      loginPass.type = loginPass.type==='password' ? 'text' : 'password';
      togglePass.textContent = loginPass.type==='password' ? 'Show' : 'Hide';
    })

    logoutBtn.addEventListener('click', ()=>{ auth.logout(); leaveDashboard() });
    navLogoutBtn.addEventListener('click', ()=>{ auth.logout(); leaveDashboard() });
    $('#navHomeBtn').addEventListener('click', ()=>{ auth.logout(); leaveDashboard() });

    // Sidebar navigation
    nav.addEventListener('click', (e)=>{
      const it = e.target.closest('.item'); if(!it) return;
      const target = it.dataset.target; setActive(target);
      if(target==='reports') renderReports();
      if(target==='takeAttendance') renderAttendanceTable();
      if(target==='studentHome') renderStudentHome();
    })

    // Quick actions
    $('#quickTakeBtn').addEventListener('click', ()=>{ setActive('takeAttendance'); renderAttendanceTable() });
    $('#seedBtn').addEventListener('click', ()=>{ if(confirm('Reset demo data?')){ seedDemo(); refreshLandingStats(); refreshTeacherStats(); listStudents(); renderAttendanceTable(); renderReports(); } })

    // Bootstrap
    ensureSeed();
    refreshLandingStats();
    todayDate.textContent = new Date().toLocaleDateString();
    const existing = auth.load(); if(existing){ enterDashboard() } else { leaveDashboard() }
  </script>
</body>
</html>
